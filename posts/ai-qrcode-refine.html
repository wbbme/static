<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="author" content="Bob Wang"><meta http-equiv="X-UA-Compatible" content="chrome=1"><meta name="revisit-after" content="7 days"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="alternate" type="application/rss+xml" title="Bob Wang's Blog" href="/feed.xml"><meta name="msapplication-TileColor" content="#ffffff"><title>Refining AI Generated QR Code</title><script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><script type="module" crossorigin="" src="/assets/app-NfkmQghJ.js"></script><link rel="stylesheet" crossorigin="" href="/assets/app-hL_ksGYg.css"><link rel="modulepreload" crossorigin="" href="/assets/ai-qrcode-refine-fyoKdRws.js"><link rel="modulepreload" crossorigin="" href="/assets/QRNotScannable-dnmMGvEf.js"><meta property="og:title" content="Refining AI Generated QR Code"><meta name="twitter:title" content="Refining AI Generated QR Code"><meta property="og:image" content="https://antfu.me/og/ai-qrcode-refine.png"><meta name="twitter:image" content="https://antfu.me/og/ai-qrcode-refine.png"><meta name="twitter:card" content="summary_large_image"></head><body class="font-sans text-gray-700 dark:text-gray-200 relative"><div id="app" data-server-rendered="true"><!--[--><header class="header z-40" data-v-ca15ab0d=""><a href="/" class="absolute xl:fixed m-5 select-none outline-none" focusable="false" data-v-ca15ab0d=""><svg width="36" height="36" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-ca15ab0d="" data-v-5728e860=""><mask id="mask0_1299_11" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="11" y="18" width="77" height="64" data-v-5728e860=""><path d="M52.2536 75.2558C60.9986 80.2021 83.5148 80.2021 84.9522 68.4071C86.5287 55.4707 48.5788 43.042 47.3108 54.4868C46.0428 65.9317 84.1918 54.7097 83.0511 41.7732C81.9796 29.621 52.4649 26.3636 32.5417 37.9684C21.9604 44.1318 11.3085 56.2316 14.6122 69.929C17.2735 80.963 34.8266 82.2429 47.3108 71.0705C61.3382 58.517 64.7195 28.206 78.6674 21" stroke="black" stroke-width="4" stroke-linecap="round" data-v-5728e860=""></path></mask><g mask="url(#mask0_1299_11)" data-v-5728e860=""><path class="path1" d="M52.2536 75.2558C60.9986 80.2021 83.5148 80.2021 84.9522 68.4071C86.5287 55.4707 48.5788 43.042 47.3108 54.4868C46.0428 65.9317 84.1918 54.7097 83.0511 41.7732C81.9796 29.621 52.4649 26.3636 32.5417 37.9684C21.9604 44.1318 11.3085 56.2316 14.6122 69.929C17.2735 80.963 34.8266 82.2429 47.3108 71.0705C61.3382 58.517 64.7195 28.206 78.6674 21" stroke="black" stroke-width="4" stroke-linecap="round" data-v-5728e860=""></path></g></svg></a><button title="Scroll to top" fixed="" right-3="" bottom-3="" w-10="" h-10="" hover:op100="" rounded-full="" hover-bg-hex-8883="" transition="" duration-300="" z-100="" print:hidden="" class="op0! pointer-events-none" data-v-ca15ab0d=""><div i-ri-arrow-up-line="" data-v-ca15ab0d=""></div></button><nav class="nav" data-v-ca15ab0d=""><div class="spacer" data-v-ca15ab0d=""></div><div class="right" print:op0="" data-v-ca15ab0d=""><a href="/" class="" title="Home" data-v-ca15ab0d=""><span class="lt-md:hidden" data-v-ca15ab0d="">Home</span><div i-ri-article-line="" md:hidden="" data-v-ca15ab0d=""></div></a><a href="/posts" class="" title="Blog" data-v-ca15ab0d=""><span class="lt-md:hidden" data-v-ca15ab0d="">Blog</span><div i-ri-article-line="" md:hidden="" data-v-ca15ab0d=""></div></a><a href="/projects" class="" title="Projects" data-v-ca15ab0d=""><span class="lt-md:hidden" data-v-ca15ab0d="">Projects</span><div i-ri-lightbulb-line="" class="md:hidden" data-v-ca15ab0d=""></div></a><a href="/talks" class="lt-md:hidden" title="Talks" data-v-ca15ab0d="">Talks </a><a href="/podcasts" class="lt-md:hidden" title="Podcasts" data-v-ca15ab0d="">Podcasts </a><a href="/demos" class="" title="Demos" data-v-ca15ab0d=""><span class="lt-md:hidden" data-v-ca15ab0d="">Demos</span><div i-ri-screenshot-line="" class="md:hidden" data-v-ca15ab0d=""></div></a><a href="/chat" class="" title="Let's Chat" data-v-ca15ab0d=""><div i-ri-chat-1-line="" data-v-ca15ab0d=""></div></a><a href="/sponsors-list" class="" title="Sponsors" data-v-ca15ab0d=""><div i-ri-user-heart-line="" data-v-ca15ab0d=""></div></a><a href="https://github.com/wbbme" target="_blank" title="GitHub" class="lt-md:hidden" data-v-ca15ab0d=""><div i-uil-github-alt="" data-v-ca15ab0d=""></div></a><a href="https://twitter.com/wbbmex" target="_blank" title="Twitter" class="lt-md:hidden" data-v-ca15ab0d=""><div i-ri-twitter-x-fill="" data-v-ca15ab0d=""></div></a><a href="/feed.xml" target="_blank" title="RSS" class="lt-md:hidden" data-v-ca15ab0d=""><div i-la-rss-square="" style="font-size:1.25rem;margin:0 -.125rem" data-v-ca15ab0d=""></div></a><a class="select-none" title="Toggle Color Scheme" data-v-ca15ab0d=""><div i-ri-sun-line="" dark:i-ri-moon-line=""></div></a></div></nav></header><main class="px-7 py-10 of-x-hidden"><!--[--><!----><div class="prose m-auto mb-8"><h1 class="mb-0 slide-enter-50">Refining AI Generated QR Code</h1><p class="opacity-50 !-mt-6 slide-enter-50">Jul 1, 2023 <span>¬∑ 16min</span></p><!----><!----><!----></div><article class=""><!--[--><div class="prose m-auto slide-enter-content"><p></p><div class="table-of-contents"><div class="table-of-contents-anchor"><div class="i-ri-menu-2-fill"></div></div><ul><li><a href="#generating-the-base-qr-code">Generating the Base QR Code</a></li><li><a href="#generating-the-images">Generating the Images</a></li><li><a href="#verify-and-refine-the-qr-code">Verify and Refine the QR Code</a></li><li><a href="#final">Final</a></li><li><a href="#hide-the-markers">Hide the Markers</a></li><li><a href="#bonus-tip-distort-the-qr">Bonus Tip: Distort the QR</a></li><li><a href="#conclusion">Conclusion</a></li></ul></div><p></p><blockquote><p><strong>Update</strong>: New blog posts - <a href="/posts/ai-qrcode-101"><strong>Stable Diffusion QR Code 101</strong></a></p></blockquote><p>Last week, I wrote a <a href="/posts/ai-qrcode">blog post</a> about how I learned to generate scannable QR Codes. When doing so, I consider my goal is to find an image that looks like a QR Code as little as possible to humans, but still be recognizable by the machine.</p><p>We need to find a balance, tweaking the weights to try and error. It‚Äôs still quite hard to find a good composition that represents the black &amp; white spots, while keeping the content meaningful to human. If you go too far, the QR Code will be unscannable, and if you don‚Äôt go far enough, the image will just be like a boring QR Code.</p><p>Since there is quite some randomness in the process, sometimes it could be a pity when you find a good one but realize it‚Äôs not scannable. To improve this, my workflow was to open up Photoshop, overlay the generated image with the original QR Code, manually check the difference, use the brush to mark those spots and send to <strong>inpaint</strong> to draw those areas. It works to some extent, but pretty inefficient as you need to go back and forth quite a few times. Meanwhile, doing this manually can also be inaccurate as the scanning algorithm might see them differently.</p><p><img src="/images/ai-qrcode-refine-5.jpg" alt="Steps from QR Code to final image"></p><p>So, I need to find a way to automate this, helping me to verify and refine the generated QR Code easier. And I came up with a simple web tool to do so. Let me introduce you to a bit about it.</p><div i-ri-arrow-right-line=""></div><a href="https://qrcode.antfu.me/" target="_blank">Anthony's QR Code Toolkit</a><h2 id="generating-the-base-qr-code" tabindex="-1">Generating the Base QR Code <a class="header-anchor" href="#generating-the-base-qr-code" aria-hidden="true">#</a></h2><p>One thing I found quite important is that the generated QR Code we put in the ControlNet affects the image quite a lot. The basic square QR Code will lead to a more square-ish and blocky image. It‚Äôs worth to try with dots, rounded, or other styled QR Codes to see if they can help to generate a better image.</p><p><img src="/images/ai-qrcode-refine-input-compare.jpg" alt="Comparison grid between different styled QR Code as input"></p><p>The images above are generated with the exactly same parameters, and the same seed, except the QR Code inputs has slightly different on the styles. You can see the difference is quite significant.</p><p>In addition, since the distribution of QR Codes is directly affecting the image‚Äôs composition. Sometimes we might find some patterns might be hard to work around. We would need to find different versions of the QR Code to find a better fit to the image we want. If you are familiar with QR Code enough, you might know there is a step in QR Code generated called <a href="https://en.wikipedia.org/wiki/QR_code#Encoding" target="_blank" rel="noopener">Mask Pattern</a>. There are in total 8 different kind of patterns can apply to the QR Code that serves the same content. Sadly, most of the generators do not provide the capability to change it. Ok, I‚Äôll build it.</p><p>So specifically for this need, I built a QR generator based on <a href="https://www.nayuki.io/page/qr-code-generator-library" target="_blank" rel="noopener">QR Code Generator Library</a>:</p><p><img src="/images/ai-qrcode-refine-generate-1.png" alt="QR Code Generator"></p><p>It offers me the full capability of the generation process. You can change the error correction level, mask pattern, version of the QR Code, and rotation to <strong>find</strong> a good distribution of the black &amp; white spots. Also, it allows you to change the styles of the dots, or add some random noise to the border making the generated image more blended-in.</p><p><img src="/images/ai-qrcode-refine-generate-2.png" alt="QR Code Generator with Custom Styles"></p><h2 id="generating-the-images" tabindex="-1">Generating the Images <a class="header-anchor" href="#generating-the-images" aria-hidden="true">#</a></h2><p>Now we have the QR Code, we could move up to generate those images with Stable Diffusion and ControlNet. For detailed steps, please refer to <a href="/posts/ai-qrcode">my previous blog post</a>.</p><h2 id="verify-and-refine-the-qr-code" tabindex="-1">Verify and Refine the QR Code <a class="header-anchor" href="#verify-and-refine-the-qr-code" aria-hidden="true">#</a></h2><p>Running overnight, I now got like 200 images generated. Say I find one quite interesting and see some potential of being a good one. I will first use my phone to try to scan it. As mentioned earlier, you may not get lucky every time. This one is unfortunately not scannable.</p><p align="center"><img src="/images/ai-qrcode-refine-4.jpg" class="max-w-120!" alt="Picked one, right from the model"></p><p>From a glance, we see there are quite some QR Code-ish spots in this image, which should make it recognizable by the scanner. But why not? Let‚Äôs find out why:</p><p>Using the <strong>Compare</strong> tab of the <a href="https://qrcode.antfu.me/" target="_blank" rel="noopener">toolkit</a>, upload both the generated image and the original QR Code, tweak the grid size, and then we could see the mismatched spots and inspect the nodes.</p><p><img src="/images/ai-qrcode-refine-compare-1.png" alt=""></p><p>We can see that the image is not scannable because we have quite a lot of mismatches, saying that some parts of the image might not have enough contrast. Hover on the <strong>Highlight Mismatch</strong> button, we can see the mismatched spots highlighted:</p><p><img src="/images/ai-qrcode-refine-compare-2.png" alt=""></p><p>It seems the top half part of the image is a bit too dark and makes the scanner hard to distinguish. We can also try to increase the image contrast to see how it would look like in the scanner:</p><p><img src="/images/ai-qrcode-refine-compare-3.png" alt=""></p><p>Now it‚Äôs quite clear what‚Äôs the problem. Then how can we fix it? You can then try to hover on the <strong>Preview Corrected</strong> button, to see what needs to be changed:</p><p><img src="/images/ai-qrcode-refine-compare-4.png" alt=""></p><p>It will lighten the spots that are too dark, and darken the spots that are too bright. Then you see this image immediately <strong>becomes scannable</strong> now!</p><p>It‚Äôs great but definitely not the final result we would end up with. We can download the correction overlay, or the mask from the toolkit, to use them on <strong>inpaint</strong> or fine-grained adjustment in Photoshop.</p><h2 id="final" tabindex="-1">Final <a class="header-anchor" href="#final" aria-hidden="true">#</a></h2><p>After a few rounds of inpainting and adjustment, upscale to improve details, and now we have the final image as:</p><p align="center"><img src="/images/ai-qrcode-refine-final.jpg" class="max-w-120!" alt="Final result"></p><div class="v-popper v-popper--theme-dropdown" mt--2=""><!--[--><!--[--><div text-center="" op35="" mt--2="" italic="" text-sm=""><button>Not scannable?</button></div><!--]--><div id="popper_ssrqy6co_105bsd" class="v-popper__popper v-popper--theme-dropdown v-popper__popper--hidden v-popper__popper--hide-to" style="position:absolute;transform:translate3d(0,0,0)" aria-hidden="true" tabindex="0" data-popper-placement=""><div class="v-popper__backdrop"></div><div class="v-popper__wrapper" style=""><div class="v-popper__inner"><!----></div><div class="v-popper__arrow-container" style="left:0;top:0"><div class="v-popper__arrow-outer"></div><div class="v-popper__arrow-inner"></div></div></div></div><!--]--></div><p>Put it back to the toolkit, we see that the mismatched spots are now reduced a lot! Some of the mismatches are actually made on purpose, since QR Code has the error correction capability allowing that.</p><p><img src="/images/ai-qrcode-refine-compare-final-1.png" alt="Tge final result in the toolkit"></p><p>In case you are interested, here you can see what it looks like when overlaid with the original QR Code:</p><p><img src="/images/ai-qrcode-refine-compare-final-2.png" alt="The final result with the original QR Code overlayed on top"></p><p>It‚Äôs quite interesting to see how the QR Code is been distorted and blended as different parts of the image.</p><h2 id="hide-the-markers" tabindex="-1">Hide the Markers <a class="header-anchor" href="#hide-the-markers" aria-hidden="true">#</a></h2><p>The current result is already surprisingly good to me. The only thing that is missing probably is that the position makers do not blend very well, but I guess that‚Äôs kinda the limitation. When I was about to call it a day and go to bed, thinking about the possibility of making the QR Code makers less obvious, I saw in <a href="https://classic.qrbtf.com/" target="_blank" rel="noopener">classic.qrbtf.com</a> (created by the creator that came up with the AI QR Code idea), there is a style call SP-1 that has a "Plus shape" style of the position markers. It looks much less artificial than the squared or double-circle ones. I didn‚Äôt know it would also work for the scanner, so I think it might be worth a try.</p><p><img src="/images/ai-qrcode-refine-qrbft.png" alt="Styles in classic.qrbtf.com"></p><p>So I implemented it in my generator, and it looks like this:</p><p><img src="/images/ai-qrcode-refine-plus-sign.png" alt="QR Code generator with plus sign shaped markers"></p><p>As you can see, the marker looks much less distinguishable from the other data points (be aware it also make the code less scannable). It might be worth trying as the control net input to see if it can generate better images. But since we already have a pretty good one, let‚Äôs use the new QR Code to redraw the markers.</p><p>So doing the inpainting process again using the new QR Code, and a few more editing, we have the <strong>final result</strong> as:</p><p align="center"><img src="/images/ai-qrcode-refine-no-anchor.png" class="max-w-120!" alt="Final result"></p><div class="v-popper v-popper--theme-dropdown" mt--2=""><!--[--><!--[--><div text-center="" op35="" mt--2="" italic="" text-sm=""><button>Not scannable?</button></div><!--]--><div id="popper_4tyj4cvq_105bse" class="v-popper__popper v-popper--theme-dropdown v-popper__popper--hidden v-popper__popper--hide-to" style="position:absolute;transform:translate3d(0,0,0)" aria-hidden="true" tabindex="0" data-popper-placement=""><div class="v-popper__backdrop"></div><div class="v-popper__wrapper" style=""><div class="v-popper__inner"><!----></div><div class="v-popper__arrow-container" style="left:0;top:0"><div class="v-popper__arrow-outer"></div><div class="v-popper__arrow-inner"></div></div></div></div><!--]--></div><p>Even though I made it step by step, it‚Äôs still mind-blowing to see the final result looks like this but still scannable! ü§Ø</p><p><a href="https://civitai.com/images/1350374" target="_blank" rel="noopener">Check it on Civital</a></p><h2 id="bonus-tip-distort-the-qr" tabindex="-1">Bonus Tip: Distort the QR <a class="header-anchor" href="#bonus-tip-distort-the-qr" aria-hidden="true">#</a></h2><p>Since we found the QR Code input affects the output image quite significantly. In another way of thinking, instead of refining the generated image in the post, maybe we can also try to manipulate the QR Code itself before sending it to the model.</p><p>For example, we could use the generator to try different patterns and configurations, to generate a better distribution of the data points. Adding some noise in the margin, making the position makers more randomized, and rounding up the hard edges to reduce the blocky feeling. We could have:</p><p><img src="/images/ai-qrcode-refine-distort-1.png" alt=""></p><p>Then I started to think about what more we could do. So I tried to play filter effects in Photoshop. I found that the <code>Distort &gt; Ripple</code> and <code>Pixelate &gt; Crystallize</code> filters have quite a balanced distortion effect. So I reimplemented the <strong>crystallize</strong> effect in the toolkit, and we have:</p><p><img src="/images/ai-qrcode-refine-distort-2.png" alt=""></p><p>This further blurs the distinction between data points in human eyes. Sending it to the model, we get surprisingly very good results! Here is one of the examples:</p><p align="center"><img src="/images/ai-qrcode-refine-distort-result.png" class="max-w-120!" alt="Distorted QR Code"></p><div class="v-popper v-popper--theme-dropdown" mt--2=""><!--[--><!--[--><div text-center="" op35="" mt--2="" italic="" text-sm=""><button>Not scannable?</button></div><!--]--><div id="popper_gtxctica_105bse" class="v-popper__popper v-popper--theme-dropdown v-popper__popper--hidden v-popper__popper--hide-to" style="position:absolute;transform:translate3d(0,0,0)" aria-hidden="true" tabindex="0" data-popper-placement=""><div class="v-popper__backdrop"></div><div class="v-popper__wrapper" style=""><div class="v-popper__inner"><!----></div><div class="v-popper__arrow-container" style="left:0;top:0"><div class="v-popper__arrow-outer"></div><div class="v-popper__arrow-inner"></div></div></div></div><!--]--></div><p>Since input has much more soft edges with some shades, it makes the model being able to "guess" with items with more freedom. Hope you‚Äôll find this tip useful! I will try to implement more useful effects in the toolkit as we go.</p><h2 id="conclusion" tabindex="-1">Conclusion <a class="header-anchor" href="#conclusion" aria-hidden="true">#</a></h2><p>I hope you enjoy the walkthrough. If you just started doing AI QR Code, give a try to the tool and let me know if it helps. You can find the app and the source code below.</p><div i-ri-qr-code-line=""></div><a href="https://qrcode.antfu.me/" target="_blank">Anthony's QR Code Toolkit</a><br><div i-ri-github-fill=""></div><a href="https://github.com/antfu/qrcode-toolkit" target="_blank" font-mono="">antfu/qrcode-toolkit</a><p>Join my <a href="https://chat.antfu.me" target="_blank" rel="noopener"><span op75="" i-simple-icons-discord=""></span> Discord Server</a>, share what you are working on, and let‚Äôs explore more together!</p><p>If you are interested in how I make such tools, I‚Äôd recommend continuing reading <a href="/posts/about-yak-shaving">About Yak Shaving</a> to learn the philosophy I follow when building tools. And if you like my work, consider sponsoring on <a href="https://github.com/sponsors/antfu" target="_blank" rel="noopener"><span i-carbon-favorite=""></span> GitHub Sponsor</a> or <a href="https://afdian.net/a/antfu" target="_blank" rel="noopener"><span i-carbon-lightning=""></span> Áà±ÂèëÁîµ</a> to support me in coming up with more ideas and tools.</p><p>Thank you and happy hacking!</p></div><!--]--></article><div class="prose m-auto mt-8 mb-8 slide-enter animate-delay-500 print:hidden"><!--[--><span font-mono="" op50="">&gt; </span><span op50="">comment on </span><a href="https://elk.zone/intent/post?text=Reading%20%40antfu%40m.webtoo.ls's%20https%3A%2F%2Fantfu.me%2Fposts%2Fai-qrcode-refine%0A%0AI%20think..." target="_blank" op50="">mastodon</a><span op25=""> / </span><a href="https://twitter.com/intent/tweet?text=Reading%20%40antfu7's%20https%3A%2F%2Fantfu.me%2Fposts%2Fai-qrcode-refine%0A%0AI%20think..." target="_blank" op50="">twitter</a><!--]--><br><span font-mono="" op50="">&gt; </span><a href="/posts" class="font-mono op50 hover:op75"></a></div><!--]--><div class="mt-10 mb-6 prose m-auto flex slide-enter animate-delay-1200!"><span class="text-sm op50"><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" style="color:inherit">CC BY-NC-SA 4.0</a> 2018 - 2024 ¬© WBB.ME</span><div class="flex-auto"></div></div></main><!----><!--]--></div><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></body></html>
<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="author" content="Bob Wang"><meta http-equiv="X-UA-Compatible" content="chrome=1"><meta name="revisit-after" content="7 days"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="alternate" type="application/rss+xml" title="Bob Wang's Blog" href="/feed.xml"><meta name="msapplication-TileColor" content="#ffffff"><title>Make Libraries Working with Vue 2 and 3</title><script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><script type="module" crossorigin="" src="/assets/app-NfkmQghJ.js"></script><link rel="stylesheet" crossorigin="" href="/assets/app-hL_ksGYg.css"><link rel="modulepreload" crossorigin="" href="/assets/make-libraries-working-with-vue-2-and-3-Xnvd5_M0.js"><meta property="og:title" content="Make Libraries Working with Vue 2 and 3"><meta name="twitter:title" content="Make Libraries Working with Vue 2 and 3"><meta name="description" content="Try Vue Demi!"><meta property="og:description" content="Try Vue Demi!"><meta name="twitter:description" content="Try Vue Demi!"><meta property="og:image" content="https://antfu.me/og/make-libraries-working-with-vue-2-and-3.png"><meta name="twitter:image" content="https://antfu.me/og/make-libraries-working-with-vue-2-and-3.png"><meta name="twitter:card" content="summary_large_image"></head><body class="font-sans text-gray-700 dark:text-gray-200 relative"><div id="app" data-server-rendered="true"><!--[--><header class="header z-40" data-v-ca15ab0d=""><a href="/" class="absolute xl:fixed m-5 select-none outline-none" focusable="false" data-v-ca15ab0d=""><svg width="36" height="36" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-ca15ab0d="" data-v-5728e860=""><mask id="mask0_1299_11" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="11" y="18" width="77" height="64" data-v-5728e860=""><path d="M52.2536 75.2558C60.9986 80.2021 83.5148 80.2021 84.9522 68.4071C86.5287 55.4707 48.5788 43.042 47.3108 54.4868C46.0428 65.9317 84.1918 54.7097 83.0511 41.7732C81.9796 29.621 52.4649 26.3636 32.5417 37.9684C21.9604 44.1318 11.3085 56.2316 14.6122 69.929C17.2735 80.963 34.8266 82.2429 47.3108 71.0705C61.3382 58.517 64.7195 28.206 78.6674 21" stroke="black" stroke-width="4" stroke-linecap="round" data-v-5728e860=""></path></mask><g mask="url(#mask0_1299_11)" data-v-5728e860=""><path class="path1" d="M52.2536 75.2558C60.9986 80.2021 83.5148 80.2021 84.9522 68.4071C86.5287 55.4707 48.5788 43.042 47.3108 54.4868C46.0428 65.9317 84.1918 54.7097 83.0511 41.7732C81.9796 29.621 52.4649 26.3636 32.5417 37.9684C21.9604 44.1318 11.3085 56.2316 14.6122 69.929C17.2735 80.963 34.8266 82.2429 47.3108 71.0705C61.3382 58.517 64.7195 28.206 78.6674 21" stroke="black" stroke-width="4" stroke-linecap="round" data-v-5728e860=""></path></g></svg></a><button title="Scroll to top" fixed="" right-3="" bottom-3="" w-10="" h-10="" hover:op100="" rounded-full="" hover-bg-hex-8883="" transition="" duration-300="" z-100="" print:hidden="" class="op0! pointer-events-none" data-v-ca15ab0d=""><div i-ri-arrow-up-line="" data-v-ca15ab0d=""></div></button><nav class="nav" data-v-ca15ab0d=""><div class="spacer" data-v-ca15ab0d=""></div><div class="right" print:op0="" data-v-ca15ab0d=""><a href="/" class="" title="Home" data-v-ca15ab0d=""><span class="lt-md:hidden" data-v-ca15ab0d="">Home</span><div i-ri-article-line="" md:hidden="" data-v-ca15ab0d=""></div></a><a href="/posts" class="" title="Blog" data-v-ca15ab0d=""><span class="lt-md:hidden" data-v-ca15ab0d="">Blog</span><div i-ri-article-line="" md:hidden="" data-v-ca15ab0d=""></div></a><a href="/projects" class="" title="Projects" data-v-ca15ab0d=""><span class="lt-md:hidden" data-v-ca15ab0d="">Projects</span><div i-ri-lightbulb-line="" class="md:hidden" data-v-ca15ab0d=""></div></a><a href="/talks" class="lt-md:hidden" title="Talks" data-v-ca15ab0d="">Talks </a><a href="/podcasts" class="lt-md:hidden" title="Podcasts" data-v-ca15ab0d="">Podcasts </a><a href="/demos" class="" title="Demos" data-v-ca15ab0d=""><span class="lt-md:hidden" data-v-ca15ab0d="">Demos</span><div i-ri-screenshot-line="" class="md:hidden" data-v-ca15ab0d=""></div></a><a href="/chat" class="" title="Let's Chat" data-v-ca15ab0d=""><div i-ri-chat-1-line="" data-v-ca15ab0d=""></div></a><a href="/sponsors-list" class="" title="Sponsors" data-v-ca15ab0d=""><div i-ri-user-heart-line="" data-v-ca15ab0d=""></div></a><a href="https://github.com/wbbme" target="_blank" title="GitHub" class="lt-md:hidden" data-v-ca15ab0d=""><div i-uil-github-alt="" data-v-ca15ab0d=""></div></a><a href="https://twitter.com/wbbmex" target="_blank" title="Twitter" class="lt-md:hidden" data-v-ca15ab0d=""><div i-ri-twitter-x-fill="" data-v-ca15ab0d=""></div></a><a href="/feed.xml" target="_blank" title="RSS" class="lt-md:hidden" data-v-ca15ab0d=""><div i-la-rss-square="" style="font-size:1.25rem;margin:0 -.125rem" data-v-ca15ab0d=""></div></a><a class="select-none" title="Toggle Color Scheme" data-v-ca15ab0d=""><div i-ri-sun-line="" dark:i-ri-moon-line=""></div></a></div></nav></header><main class="px-7 py-10 of-x-hidden"><!--[--><!----><div class="prose m-auto mb-8"><h1 class="mb-0 slide-enter-50">Make Libraries Working with Vue 2 and 3</h1><p class="opacity-50 !-mt-6 slide-enter-50">Jul 1, 2020 <span>Â· 5min</span></p><!----><!----><!----></div><article class=""><!--[--><div class="prose m-auto slide-enter-content"><p>Today, Evan has announced that the first RC of Vue 3 <a href="https://github.com/vuejs/rfcs/issues/183" target="_blank" rel="noopener">will be released in mid-July</a>. The post suggests library/plugin authors to start migrating the support for Vue 3. But as the APIs and behaviors have changed a lot, is that possible to make our libraries support Vue 2 and 3 at the same time?</p><h2 id="universal-code" tabindex="-1">Universal Code <a class="header-anchor" href="#universal-code" aria-hidden="true">#</a></h2><p>The most simple way is to write universal code that works in both versions without any additional modification, just like people would do for <a href="https://python-future.org/compatible_idioms.html" target="_blank" rel="noopener">Python 2 and 3</a>. Simple does not mean itâ€™s easy. Write such components requires you to avoid <strong>things that newly introduced in Vue 3</strong> and <strong>things that deprecated from Vue 2</strong>. In other words, you canâ€™t use:</p><ul><li>Composition API</li><li><code>.sync</code> <code>.native</code> modifiers</li><li>Filters</li><li><a href="/posts/vue-3-notes#-use-markraw-for-vendor-objects">3rd-parties vendor objects</a></li><li>etc. (let me know if I missed anything and I will update the list)</li></ul><p>This just makes life harder and you canâ€™t benefit from the new awesome APIs in Vue 3.</p><h2 id="use-branches" tabindex="-1">Use Branches <a class="header-anchor" href="#use-branches" aria-hidden="true">#</a></h2><p><a href="https://github.com/vuejs/rfcs/issues/183#issuecomment-652134760" target="_blank" rel="noopener">A reply</a> to <a href="https://github.com/vuejs/rfcs/issues/183#issuecomment-651944231" target="_blank" rel="noopener">this problem</a> from a core team member suggests using different branches to separate your support for each targeting version. I think itâ€™s a good solution for existing and mature libraries as their codebases are usually more stable and version targeting optimization might require them to have better code isolations.</p><p>The drawback of this is that you will need to maintain two codebases which double your workload. For small scale libraries or new libraries that want to support both versions, doing bugfix or feature supplements twice is just no ideal. I would not recommend using this approach at the very beginning of your projects.</p><h2 id="build-scripts" tabindex="-1">Build Scripts <a class="header-anchor" href="#build-scripts" aria-hidden="true">#</a></h2><p>In <a href="https://github.com/antfu/vueuse" target="_blank" rel="noopener">VueUse</a>, I wrote <a href="https://github.com/antfu/vueuse/tree/main/scripts" target="_blank" rel="noopener">some build scripts</a> to make the code imports from the target versionâ€™s API while building. After that, I would need to publish two tags <code>vue2</code> <code>vue3</code> to distinguish different version supports. With this, I can wite the code once and make the library supports both Vue versions. The problem of it is that I need to build twice on each release and guide users to install with the corresponding plugin version (and manually install <a href="https://github.com/vuejs/composition-api" target="_blank" rel="noopener"><code>@vue/composition-api</code></a> for Vue 2).</p><hr><p>It has been several months since I wrote VueUse. During this period, I am always trying to figure out a proper way to extract the logic from VueUse, so it can be reused and benefit other library authors. But after all, I still think itâ€™s just too complicated to be used in general.</p><p>However, at the moment I started to write this post, I came up with the idea - providing the universal interface for both versions. If it works, in this way, authors are no need to worried about the usersâ€™ environments anymore.</p><p>And after some experimentsâ€¦</p><h2 id="ðŸŽ©-introducing-vue-demi" tabindex="-1">ðŸŽ© Introducing <a href="https://github.com/antfu/vue-demi" target="_blank" rel="noopener">Vue Demi</a> <a class="header-anchor" href="#ðŸŽ©-introducing-vue-demi" aria-hidden="true">#</a></h2><p><a href="https://github.com/antfu/vue-demi" target="_blank" rel="noopener"><strong>Vue Demi</strong></a> is a developing utility that allows you to write Universal Vue Libraries for Vue 2 and 3. Without worrying about usersâ€™ installed versions.</p><p>When you are going to create a Vue plugin/library, simply install <code>vue-demi</code> as your dependency and import anything related to Vue from it. Publish your plugin/library as usual, your package would become universal!</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-json"><span class="line"><span style="--s-dark:#666666;--s-light:#999999">{</span></span>
<span class="line"><span style="--s-dark:#C98A7D99;--s-light:#B5695999">  "</span><span style="--s-dark:#B8A965;--s-light:#998418">dependencies</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">"</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C98A7D99;--s-light:#B5695999">    "</span><span style="--s-dark:#B8A965;--s-light:#998418">vue-demi</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">"</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">latest</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">"</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Vue</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> reactive</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> ref</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">vue-demi</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span>
<span class="line"></span></code></pre><p>Underhood, it utilized the <a href="https://docs.npmjs.com/misc/scripts" target="_blank" rel="noopener"><code>postinstall</code> npm hook</a>. After all packages get installed, <a href="https://github.com/antfu/vue-demi/blob/main/scripts/postinstall.js" target="_blank" rel="noopener">the script</a> will start to check the installed Vue version and redirect the exports to based on the local Vue version. When working with Vue 2, it will also install <code>@vue/composition-api</code> automatically if it doesnâ€™t get installed.</p><p>You can also check <a href="https://github.com/antfu/vue-demi/tree/main/examples" target="_blank" rel="noopener">the working examples</a>, where I created a demo library <a href="https://github.com/antfu/vue-demi/blob/main/examples/%40vue-demi/use-mouse/src/index.ts" target="_blank" rel="noopener"><code>@vue-demi/use-mouse</code></a> with just a single file entry.</p><p>Please keep in mind that Vue Demi is experimental and there will definitely be some glitches. Feel free to give it a try and let me know if anything goes wrong.</p><p>Thanks and happy hacking!</p></div><!--]--></article><div class="prose m-auto mt-8 mb-8 slide-enter animate-delay-500 print:hidden"><!--[--><span font-mono="" op50="">&gt; </span><span op50="">comment on </span><a href="https://elk.zone/intent/post?text=Reading%20%40antfu%40m.webtoo.ls's%20https%3A%2F%2Fantfu.me%2Fposts%2Fmake-libraries-working-with-vue-2-and-3%0A%0AI%20think..." target="_blank" op50="">mastodon</a><span op25=""> / </span><a href="https://twitter.com/intent/tweet?text=Reading%20%40antfu7's%20https%3A%2F%2Fantfu.me%2Fposts%2Fmake-libraries-working-with-vue-2-and-3%0A%0AI%20think..." target="_blank" op50="">twitter</a><!--]--><br><span font-mono="" op50="">&gt; </span><a href="/posts" class="font-mono op50 hover:op75"></a></div><!--]--><div class="mt-10 mb-6 prose m-auto flex slide-enter animate-delay-1200!"><span class="text-sm op50"><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" style="color:inherit">CC BY-NC-SA 4.0</a> 2018 - 2024 Â© WBB.ME</span><div class="flex-auto"></div></div></main><!----><!--]--></div><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></body></html>
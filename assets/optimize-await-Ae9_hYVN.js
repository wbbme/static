import{u as e,c as n,w as i,_ as r,o as p,a as s,d as a}from"./app-NfkmQghJ.js";const d=s("div",{class:"prose m-auto slide-enter-content"},[s("p",null,[s("code",null,"async"),a(" / "),s("code",null,"await"),a(" in ES7 is truly a life-saver for the JavaScript world. It allows you to avoid "),s("a",{href:"http://callbackhell.com/",target:"_blank",rel:"noopener"},"callback hell"),a(" in your code and make it more readable. However, a common pitfall is that when you "),s("code",null,"await"),a(" a huge asynchronous task that takes very long time, it blocks the following code and could potentially make your app slow.")]),s("p",null,"For example:"),s("pre",{class:"shiki shiki-themes vitesse-dark vitesse-light",style:{"--s-dark":"#dbd7caee","--s-light":"#393a34","--s-dark-bg":"#121212","--s-light-bg":"#ffffff"},tabindex:"0"},[s("code",{class:"language-ts"},[s("span",{class:"line"},[s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}},"const "),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"app"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," ="),s("span",{style:{"--s-dark":"#4D9375","--s-light":"#1E754F"}}," await"),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}}," createServer"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"()")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}},"const "),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"middlewareA"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," ="),s("span",{style:{"--s-dark":"#4D9375","--s-light":"#1E754F"}}," await"),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}}," resolveMiddlewareA"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"()")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}},"const "),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"middlewareB"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," ="),s("span",{style:{"--s-dark":"#4D9375","--s-light":"#1E754F"}}," await"),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}}," resolveMiddlewareB"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"()")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"app"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"."),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}},"use"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"("),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"middlewareA"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},")")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"app"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"."),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}},"use"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"("),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"middlewareB"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},")")]),a(`
`),s("span",{class:"line"})])]),s("p",null,[a("We have used three "),s("code",null,"await"),a(" in the example, while the three async function does not actually relying on each other, having them sequentially we are possibility wasted some time of the operations that could be parallelized (IO, Network, etc.)")]),s("p",null,[a("So we can use "),s("a",{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all",target:"_blank",rel:"noopener"},[s("code",null,"Promise.all")]),a(" to optimize the code:")]),s("pre",{class:"shiki shiki-themes vitesse-dark vitesse-light",style:{"--s-dark":"#dbd7caee","--s-light":"#393a34","--s-dark-bg":"#121212","--s-light-bg":"#ffffff"},tabindex:"0"},[s("code",{class:"language-ts"},[s("span",{class:"line"},[s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}},"const "),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"["),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"app"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},","),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}}," middlewareA"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},","),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}}," middlewareB"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"]"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," ="),s("span",{style:{"--s-dark":"#4D9375","--s-light":"#1E754F"}}," await"),s("span",{style:{"--s-dark":"#B8A965","--s-light":"#998418"}}," Promise"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"."),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}},"all"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"(")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"  [")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}},"    createServer"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"(),")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}},"    resolveMiddlewareA"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"(),")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}},"    resolveMiddlewareB"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"(),")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"  ],")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},")")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"app"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"."),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}},"use"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"("),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"middlewareA"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},")")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"app"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"."),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}},"use"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"("),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"middlewareB"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},")")]),a(`
`),s("span",{class:"line"})])]),s("p",null,"In another example, you might relying on the async result, but sometime not that urgent:"),s("pre",{class:"shiki shiki-themes vitesse-dark vitesse-light",style:{"--s-dark":"#dbd7caee","--s-light":"#393a34","--s-dark-bg":"#121212","--s-light-bg":"#ffffff"},tabindex:"0"},[s("code",{class:"language-ts"},[s("span",{class:"line"},[s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}},"async"),s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}}," function"),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}}," createPlugin"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"()"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}},"  const "),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"toolkit"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," ="),s("span",{style:{"--s-dark":"#4D9375","--s-light":"#1E754F"}}," await"),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}}," initToolKit"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"()")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#4D9375","--s-light":"#1E754F"}},"  return"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}},"    onHookA"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"() {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"      toolkit"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"."),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}},"invokeA"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"()")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"    },")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}},"    onHookB"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"() {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"      toolkit"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"."),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}},"invokeB"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"()")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"    },")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"  }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"}")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}},"const "),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"plugin"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," ="),s("span",{style:{"--s-dark":"#4D9375","--s-light":"#1E754F"}}," await"),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}}," createPlugin"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"()")]),a(`
`),s("span",{class:"line"})])]),s("p",null,[a("Even though you donâ€™t need "),s("code",null,"toolkit"),a(" immediately, you are still forced to use "),s("code",null,"async function"),a(" because the "),s("code",null,"initToolKit"),a(" is async. To avoid this, we could make the promise been resolved in the hooks instead")]),s("pre",{class:"shiki shiki-themes vitesse-dark vitesse-light",style:{"--s-dark":"#dbd7caee","--s-light":"#393a34","--s-dark-bg":"#121212","--s-light-bg":"#ffffff"},tabindex:"0"},[s("code",{class:"language-ts"},[s("span",{class:"line"},[s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}},"function"),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}}," createPlugin"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"()"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}},"  const "),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"toolkitPromise"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," ="),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}}," initToolKit"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"()")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#4D9375","--s-light":"#1E754F"}},"  return"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}},"    async"),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}}," onHookA"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"() {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}},"      const "),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"toolkit"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," ="),s("span",{style:{"--s-dark":"#4D9375","--s-light":"#1E754F"}}," await"),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}}," toolkitPromise")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"      toolkit"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"."),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}},"invokeA"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"()")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"    },")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}},"    async"),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}}," onHookB"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"() {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}},"      const "),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"toolkit"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," ="),s("span",{style:{"--s-dark":"#4D9375","--s-light":"#1E754F"}}," await"),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}}," toolkitPromise")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"      toolkit"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"."),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}},"invokeB"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"()")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"    },")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"  }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"}")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#758575DD","--s-light":"#A0ADA0"}},"// now it's sync!")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}},"const "),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"plugin"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," ="),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}}," createPlugin"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"()")]),a(`
`),s("span",{class:"line"})])]),s("p",null,[a("Since a Promise could only "),s("a",{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise#description",target:"_blank",rel:"noopener"},"be resolved once"),a(", using multiple "),s("code",null,"await"),a(" for a single Promise instance is "),s("a",{href:"https://blog.ashleygrant.com/2020/04/30/resolved-javascript-promises-can-be-used-multiple-times/",target:"_blank",rel:"noopener"},"totally fine"),a(" - it will return the resolved result immediate if the Promise is allready settled.")]),s("p",null,"To be more generalized, we could have an utility function like:"),s("pre",{class:"shiki shiki-themes vitesse-dark vitesse-light",style:{"--s-dark":"#dbd7caee","--s-light":"#393a34","--s-dark-bg":"#121212","--s-light-bg":"#ffffff"},tabindex:"0"},[s("code",{class:"language-ts"},[s("span",{class:"line"},[s("span",{style:{"--s-dark":"#4D9375","--s-light":"#1E754F"}},"export"),s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}}," function"),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}}," createSingletonPromise"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"<"),s("span",{style:{"--s-dark":"#5DA994","--s-light":"#2E8F82"}},"T"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},">("),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}},"fn"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},": () => "),s("span",{style:{"--s-dark":"#5DA994","--s-light":"#2E8F82"}},"Promise"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"<"),s("span",{style:{"--s-dark":"#5DA994","--s-light":"#2E8F82"}},"T"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},">)"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}},"  let "),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"_promise"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},": "),s("span",{style:{"--s-dark":"#5DA994","--s-light":"#2E8F82"}},"Promise"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"<"),s("span",{style:{"--s-dark":"#5DA994","--s-light":"#2E8F82"}},"T"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"> | "),s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}},"undefined")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#4D9375","--s-light":"#1E754F"}},"  return"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," ()"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," =>"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#4D9375","--s-light":"#1E754F"}},"    if"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," ("),s("span",{style:{"--s-dark":"#CB7676","--s-light":"#AB5959"}},"!"),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"_promise"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},")")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}},"      _promise"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}}," ="),s("span",{style:{"--s-dark":"#80A665","--s-light":"#59873A"}}," fn"),s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"()")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#4D9375","--s-light":"#1E754F"}},"    return"),s("span",{style:{"--s-dark":"#BD976A","--s-light":"#B07D48"}}," _promise")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"  }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--s-dark":"#666666","--s-light":"#999999"}},"}")]),a(`
`),s("span",{class:"line"})])]),s("p",null,[a("This function is also available in my utilities collection "),s("a",{href:"https://github.com/antfu/utils",target:"_blank",rel:"noopener"},[s("code",null,"@antfu/utils")])])],-1),c={__name:"optimize-await",setup(h){const t={title:"Optimize Await",date:"2021-07-01T16:00:00.000Z",lang:"en",duration:"8min",type:"note",image:"https://antfu.me/og/optimize-await.png",meta:[{property:"og:title",content:"Optimize Await"},{name:"twitter:title",content:"Optimize Await"},{property:"og:image",content:"https://antfu.me/og/optimize-await.png"},{name:"twitter:image",content:"https://antfu.me/og/optimize-await.png"},{name:"twitter:card",content:"summary_large_image"}]};return e({title:"Optimize Await",meta:[{property:"og:title",content:"Optimize Await"},{name:"twitter:title",content:"Optimize Await"},{property:"og:image",content:"https://antfu.me/og/optimize-await.png"},{name:"twitter:image",content:"https://antfu.me/og/optimize-await.png"},{name:"twitter:card",content:"summary_large_image"}]}),(o,k)=>{const l=r;return p(),n(l,{frontmatter:t},{default:i(()=>[d]),_:1})}}};export{c as default};
